2022-05-02T01:58:22.987Z	V4	e2e	Logger init completed	{"vlevel": 4}
=== RUN   TestVSphereKubernetes121BottlerocketTo122MultipleFieldsUpgrade
2022-05-02T01:58:22.988Z	V2	e2e	Pulling docker image	{"image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.1.0-eks-a-v0.0.0-dev-build.589"}
2022-05-02T01:58:31.990Z	V3	e2e	Initializing long running container	{"name": "eksa_1651456702988024307", "image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.1.0-eks-a-v0.0.0-dev-build.589"}
2022-05-02T01:58:36.181Z	V2	e2e	Pulling docker image	{"image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.1.0-eks-a-v0.0.0-dev-build.589"}
2022-05-02T01:58:37.149Z	V3	e2e	Initializing long running container	{"name": "eksa_1651456716181926749", "image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.1.0-eks-a-v0.0.0-dev-build.589"}
    cluster.go:499: Running shell command [ eksctl anywhere generate clusterconfig main-i-0bf0c4f4f43614f61 -p vsphere > cluster.yaml ]
    cluster.go:374: Creating cluster main-i-0bf0c4f4f43614f61
    cluster.go:499: Running shell command [ eksctl anywhere create cluster -f main-i-0bf0c4f4f43614f61-config/cluster.yaml -v 4 ]
2022-05-02T01:58:41.599Z	V4	Logger init completed	{"vlevel": 4}
2022-05-02T01:58:41.710Z	V0	Warning: VSphereDatacenterConfig configured in insecure mode
2022-05-02T01:58:41.761Z	V4	Reading bundles manifest	{"url": "https://dev-release-prod-pdx.s3.amazonaws.com/bundle-release.yaml"}
2022-05-02T01:58:41.854Z	V2	Pulling docker image	{"image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.7.2-eks-a-v0.0.0-dev-build.1872"}
2022-05-02T01:58:48.444Z	V3	Initializing long running container	{"name": "eksa_1651456721854290838", "image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.7.2-eks-a-v0.0.0-dev-build.1872"}
2022-05-02T01:58:51.655Z	V4	Task start	{"task_name": "setup-validate"}
2022-05-02T01:58:51.655Z	V0	Performing setup and validations
2022-05-02T01:58:51.655Z	V0	Warning: VSphereDatacenterConfig configured in insecure mode
2022-05-02T01:58:51.681Z	V0	✅ Connected to server
2022-05-02T01:58:52.003Z	V0	✅ Authenticated to vSphere
2022-05-02T01:58:52.403Z	V0	✅ Datacenter validated
2022-05-02T01:58:52.769Z	V0	✅ Network validated
2022-05-02T01:58:55.314Z	V0	✅ Datastore validated
2022-05-02T01:58:55.666Z	V0	✅ Folder validated
2022-05-02T01:58:56.043Z	V0	✅ Resource pool validated
2022-05-02T01:58:56.368Z	V0	✅ Datastore validated
2022-05-02T01:58:56.681Z	V0	✅ Folder validated
2022-05-02T01:58:57.049Z	V0	✅ Resource pool validated
2022-05-02T01:58:57.402Z	V0	✅ Datastore validated
2022-05-02T01:58:57.729Z	V0	✅ Folder validated
2022-05-02T01:58:58.105Z	V0	✅ Resource pool validated
2022-05-02T01:58:58.922Z	V0	✅ Control plane and Workload templates validated
2022-05-02T01:59:02.476Z	V0	✅ Vsphere Provider setup is valid
2022-05-02T01:59:02.476Z	V0	✅ Validate certificate for registry mirror
2022-05-02T01:59:02.476Z	V0	✅ Create preflight validations pass
2022-05-02T01:59:02.476Z	V4	Task finished	{"task_name": "setup-validate", "duration": "10.821354902s"}
2022-05-02T01:59:02.476Z	V4	----------------------------------
2022-05-02T01:59:02.476Z	V4	Task start	{"task_name": "bootstrap-cluster-init"}
2022-05-02T01:59:02.477Z	V0	Creating new bootstrap cluster
2022-05-02T01:59:02.477Z	V4	Creating kind cluster	{"name": "main-i-0bf0c4f4f43614f61-eks-a-cluster", "kubeconfig": "main-i-0bf0c4f4f43614f61/generated/main-i-0bf0c4f4f43614f61.kind.kubeconfig"}
2022-05-02T02:00:10.571Z	V0	Provider specific pre-capi-install-setup on bootstrap cluster
2022-05-02T02:00:10.571Z	V0	Installing cluster-api providers on bootstrap cluster
2022-05-02T02:01:14.914Z	V0	Provider specific post-setup
2022-05-02T02:01:14.914Z	V4	Task finished	{"task_name": "bootstrap-cluster-init", "duration": "2m12.43798908s"}
2022-05-02T02:01:14.915Z	V4	----------------------------------
2022-05-02T02:01:14.915Z	V4	Task start	{"task_name": "workload-cluster-init"}
2022-05-02T02:01:14.915Z	V0	Creating new workload cluster
2022-05-02T02:01:17.816Z	V3	Waiting for external etcd to be ready	{"cluster": "main-i-0bf0c4f4f43614f61"}
2022-05-02T02:06:28.790Z	V3	External etcd is ready
2022-05-02T02:06:28.790Z	V3	Waiting for control plane to be ready
2022-05-02T02:11:56.186Z	V3	Waiting for workload kubeconfig generation	{"cluster": "main-i-0bf0c4f4f43614f61"}
2022-05-02T02:11:56.619Z	V3	Waiting for controlplane and worker machines to be ready
2022-05-02T02:11:56.955Z	V4	Nodes are not ready yet	{"total": 4, "ready": 3, "cluster name": "main-i-0bf0c4f4f43614f61"}
2022-05-02T02:11:57.292Z	V4	Nodes are not ready yet	{"total": 4, "ready": 3, "cluster name": "main-i-0bf0c4f4f43614f61"}
2022-05-02T02:11:58.719Z	V4	Nodes are not ready yet	{"total": 4, "ready": 3, "cluster name": "main-i-0bf0c4f4f43614f61"}
2022-05-02T02:12:00.112Z	V4	Nodes are not ready yet	{"total": 4, "ready": 3, "cluster name": "main-i-0bf0c4f4f43614f61"}
2022-05-02T02:12:01.540Z	V4	Nodes ready	{"total": 4}
2022-05-02T02:12:01.540Z	V0	Installing networking on workload cluster
2022-05-02T02:12:04.794Z	V0	Installing storage class on cluster
2022-05-02T02:12:05.419Z	V0	Installing cluster-api providers on workload cluster
2022-05-02T02:13:33.308Z	V0	Installing EKS-A secrets on workload cluster
2022-05-02T02:13:36.885Z	V4	Installing machine health checks on bootstrap cluster
2022-05-02T02:13:37.494Z	V4	Task finished	{"task_name": "workload-cluster-init", "duration": "12m22.579634219s"}
2022-05-02T02:13:37.494Z	V4	----------------------------------
2022-05-02T02:13:37.494Z	V4	Task start	{"task_name": "capi-management-move"}
2022-05-02T02:13:37.494Z	V0	Moving cluster management from bootstrap to workload cluster
2022-05-02T02:13:37.494Z	V3	Waiting for management machines to be ready before move
2022-05-02T02:13:37.958Z	V4	Nodes ready	{"total": 4}
2022-05-02T02:13:47.517Z	V3	Waiting for control planes to be ready after move
2022-05-02T02:13:51.960Z	V3	Waiting for workload cluster control plane replicas to be ready after move
2022-05-02T02:13:52.536Z	V3	Waiting for workload cluster machine deployment replicas to be ready after move
2022-05-02T02:13:53.120Z	V3	Waiting for machines to be ready after move
2022-05-02T02:13:53.470Z	V4	Nodes ready	{"total": 4}
2022-05-02T02:13:53.470Z	V4	Task finished	{"task_name": "capi-management-move", "duration": "15.976004086s"}
2022-05-02T02:13:53.470Z	V4	----------------------------------
2022-05-02T02:13:53.470Z	V4	Task start	{"task_name": "eksa-components-install"}
2022-05-02T02:13:53.470Z	V0	Installing EKS-A custom components (CRD and controller) on workload cluster
2022-05-02T02:14:06.687Z	V0	Installing EKS-D components on workload cluster
2022-05-02T02:14:09.701Z	V0	Creating EKS-A CRDs instances on workload cluster
2022-05-02T02:14:09.705Z	V4	Applying eksa yaml resources to cluster
2022-05-02T02:14:11.435Z	V1	Applying Bundles to cluster
2022-05-02T02:14:12.324Z	V4	Applying eksd manifest to cluster
2022-05-02T02:14:18.314Z	V4	Task finished	{"task_name": "eksa-components-install", "duration": "24.843417331s"}
2022-05-02T02:14:18.314Z	V4	----------------------------------
2022-05-02T02:14:18.314Z	V4	Task start	{"task_name": "addon-manager-install"}
2022-05-02T02:14:18.314Z	V0	Installing AddonManager and GitOps Toolkit on workload cluster
2022-05-02T02:14:18.314Z	V0	GitOps field not specified, bootstrap flux skipped
2022-05-02T02:14:18.314Z	V4	Task finished	{"task_name": "addon-manager-install", "duration": "12.889µs"}
2022-05-02T02:14:18.314Z	V4	----------------------------------
2022-05-02T02:14:18.314Z	V4	Task start	{"task_name": "write-cluster-config"}
2022-05-02T02:14:18.314Z	V0	Writing cluster config file
2022-05-02T02:14:18.318Z	V4	Task finished	{"task_name": "write-cluster-config", "duration": "4.545344ms"}
2022-05-02T02:14:18.318Z	V4	----------------------------------
2022-05-02T02:14:18.318Z	V4	Task start	{"task_name": "delete-kind-cluster"}
2022-05-02T02:14:18.318Z	V0	Deleting bootstrap cluster
2022-05-02T02:14:19.557Z	V4	Deleting kind cluster	{"name": "main-i-0bf0c4f4f43614f61-eks-a-cluster"}
2022-05-02T02:14:21.391Z	V0	🎉 Cluster created!
2022-05-02T02:14:21.391Z	V4	Task finished	{"task_name": "delete-kind-cluster", "duration": "3.073175598s"}
2022-05-02T02:14:21.392Z	V4	----------------------------------
2022-05-02T02:14:21.392Z	V4	Tasks completed	{"duration": "15m29.736430432s"}
2022-05-02T02:14:21.393Z	V3	Logging out from current govc session
2022-05-02T02:14:22.027Z	V3	Cleaning up long running container	{"name": "eksa_1651456721854290838"}
    cluster.go:499: Running shell command [ eksctl anywhere upgrade cluster -f main-i-0bf0c4f4f43614f61-config/cluster.yaml -v 4 ]
2022-05-02T02:14:22.226Z	V4	Logger init completed	{"vlevel": 4}
2022-05-02T02:14:22.325Z	V0	Warning: VSphereDatacenterConfig configured in insecure mode
2022-05-02T02:14:22.370Z	V4	Reading bundles manifest	{"url": "https://dev-release-prod-pdx.s3.amazonaws.com/bundle-release.yaml"}
2022-05-02T02:14:22.459Z	V2	Pulling docker image	{"image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.7.2-eks-a-v0.0.0-dev-build.1872"}
2022-05-02T02:14:23.409Z	V3	Initializing long running container	{"name": "eksa_1651457662459686545", "image": "public.ecr.aws/l0g8r8j6/eks-anywhere-cli-tools:v0.7.2-eks-a-v0.0.0-dev-build.1872"}
2022-05-02T02:14:23.806Z	V4	Task start	{"task_name": "setup-and-validate"}
2022-05-02T02:14:23.806Z	V0	Performing setup and validations
2022-05-02T02:14:23.806Z	V0	Warning: VSphereDatacenterConfig configured in insecure mode
2022-05-02T02:14:23.841Z	V0	✅ Connected to server
2022-05-02T02:14:24.159Z	V0	✅ Authenticated to vSphere
2022-05-02T02:14:24.612Z	V0	✅ Datacenter validated
2022-05-02T02:14:24.998Z	V0	✅ Network validated
2022-05-02T02:14:25.790Z	V0	Warning: Your VM template includes snapshot(s). LinkedClone mode will be used. DiskGiB cannot be customizable as disks cannot be expanded when using LinkedClone mode. Using default of 25 for DiskGiBs.
2022-05-02T02:14:26.551Z	V0	Warning: Your VM template includes snapshot(s). LinkedClone mode will be used. DiskGiB cannot be customizable as disks cannot be expanded when using LinkedClone mode. Using default of 25 for DiskGiBs.
2022-05-02T02:14:27.303Z	V0	Warning: Your VM template includes snapshot(s). LinkedClone mode will be used. DiskGiB cannot be customizable as disks cannot be expanded when using LinkedClone mode. Using default of 25 for DiskGiBs.
2022-05-02T02:14:27.683Z	V0	✅ Datastore validated
2022-05-02T02:14:28.045Z	V0	✅ Folder validated
2022-05-02T02:14:28.412Z	V0	✅ Resource pool validated
2022-05-02T02:14:28.810Z	V0	✅ Datastore validated
2022-05-02T02:14:29.254Z	V0	✅ Folder validated
2022-05-02T02:14:29.634Z	V0	✅ Resource pool validated
2022-05-02T02:14:30.068Z	V0	✅ Datastore validated
2022-05-02T02:14:30.419Z	V0	✅ Folder validated
2022-05-02T02:14:30.804Z	V0	✅ Resource pool validated
2022-05-02T02:14:31.643Z	V1	Control plane template validation failed.
2022-05-02T02:14:31.644Z	V0	❌ Validation failed	{"validation": "vsphere Provider setup is valid", "error": "template /SDDC-Datacenter/vm/Templates/bottlerocket-kube-v1-22 is missing tag eksdRelease:kubernetes-1-22-eks-6", "remediation": ""}
2022-05-02T02:14:36.269Z	V3	calculating version differences	{"inputVersion": "1.22", "clusterVersion": "1.21.9-eks-bbc8a0c"}
2022-05-02T02:14:36.269Z	V3	calculated version differences	{"majorVersionDifference": 0, "minorVersionDifference": 1}
2022-05-02T02:14:40.070Z	V0	✅ Validate certificate for registry mirror
2022-05-02T02:14:40.070Z	V0	✅ Control plane ready
2022-05-02T02:14:40.070Z	V0	✅ Worker nodes ready
2022-05-02T02:14:40.070Z	V0	✅ Nodes ready
2022-05-02T02:14:40.070Z	V0	✅ Cluster CRDs ready
2022-05-02T02:14:40.070Z	V0	✅ Cluster object present on workload cluster
2022-05-02T02:14:40.070Z	V0	✅ Upgrade cluster kubernetes version increment
2022-05-02T02:14:40.070Z	V0	✅ Validate immutable fields
2022-05-02T02:14:40.070Z	V0	✅ Upgrade preflight validations pass
2022-05-02T02:14:40.070Z	V4	Task finished	{"task_name": "setup-and-validate", "duration": "16.264093028s"}
2022-05-02T02:14:40.070Z	V4	----------------------------------
2022-05-02T02:14:40.070Z	V4	Tasks completed	{"duration": "16.264147615s"}
2022-05-02T02:14:40.070Z	V3	Logging out from current govc session
2022-05-02T02:14:40.846Z	V3	Cleaning up long running container	{"name": "eksa_1651457662459686545"}
Error: failed to upgrade cluster: validations failed
    cluster.go:532: Command eksctl anywhere [upgrade cluster -f main-i-0bf0c4f4f43614f61-config/cluster.yaml -v 4] failed with error: exit status 255: Error: failed to upgrade cluster: validations failed
2022-05-02T02:14:41.012Z	V3	e2e	Cleaning up long running container	{"name": "eksa_1651456716181926749"}
2022-05-02T02:14:41.115Z	V3	e2e	Logging out from current govc session
2022-05-02T02:14:41.800Z	V3	e2e	Cleaning up long running container	{"name": "eksa_1651456702988024307"}
--- FAIL: TestVSphereKubernetes121BottlerocketTo122MultipleFieldsUpgrade (978.93s)
FAIL

DONE 1 tests, 1 failure in 979.055s