---
title: "Creating an OIDC provider"
linkTitle: "Creating an OIDC provider"
weight: 30
date: 2021-11-11
description: >  
---
The steps below are based on the guide for configuring IRSA for DIY Kubernetes , with modifications specific to EKS Anywhereâ€™s cluster provisioning workflow. The main modification is the process of generating the keys.json document. As per the original guide, the user has to create the service account signing keys, and then use that to create the keys.json document prior to cluster creation. This order is reversed for EKS Anywhere clusters, so you will create the cluster first, and then retrieve the service account signing key generated by the cluster, and use it to create the keys.json document. The sections below show how to do this in detail.

All steps listed below have to be executed on the admin machine, before creating the workload cluster or/and the management cluster if you want to enable IRSA on. 

1. Set the following environment variables

    ```bash
    # IAM Role for Service Accounts Environment Variables
    echo "export ACCOUNT_ID=[AWS_ACCOUNT]" | tee -a ~/.bash_profile
    echo "export S3_BUCKET=irsa-dev-oidc-eksa-${ACCOUNT_ID}" | tee -a ~/.bash_profile
    echo "export AWS_REGION=[AWS_REGION_NAME]" | tee -a ~/.bash_profile
    echo "export HOSTNAME=s3.amazonaws.com" | tee -a ~/.bash_profile
    echo "export ISSUER_HOSTPATH=${HOSTNAME}/${S3_BUCKET}" | tee -a ~/.bash_profile
    source ~/.bash_profile
    ```

1. Create an s3 bucket to host the public signing keys and OIDC discovery document for your cluster. 

    ```bash
    aws s3api create-bucket --bucket $S3_BUCKET
    aws s3api put-public-access-block \
        --bucket $S3_BUCKET \
        --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
    ```

1. Create the OIDC discovery document as follows:

    ```bash
    cat <<EOF > discovery.json
    {
        "issuer": "https://$ISSUER_HOSTPATH",
        "jwks_uri": "https://$ISSUER_HOSTPATH/keys.json",
        "authorization_endpoint": "urn:kubernetes:programmatic_authorization",
        "response_types_supported": [
            "id_token"
        ],
        "subject_types_supported": [
            "public"
        ],
        "id_token_signing_alg_values_supported": [
            "RS256"
        ],
        "claims_supported": [
            "sub",
            "iss"
        ]
    }
    EOF
    ```

1. Upload it to the publicly accessible S3 bucket:

    ```bash
    aws s3 cp --acl public-read ./discovery.json \
    s3://$S3_BUCKET/.well-known/openid-configuration
    ```

1. Create an OIDC provider for your cluster using the following command. Set the Provider URL to https://$ISSUER_HOSTPATH, and audience to sts.amazonaws.com. to generate a thumbprint to use it with this command, check this [page](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc_verify-thumbprint.html). After you generate it assign it to the variable CA_THUMBPRINT. Then run the following command

    ```bash
    aws iam create-open-id-connect-provider \
        --url https://$ISSUER_HOSTPATH \
        --thumbprint-list $CA_THUMBPRINT \
        --client-id-list sts.amazonaws.com
    ```

1. Which will create it for us like that, and you will notice that the provider field holds the same value of the environment variable ISSUER_HOSTPATH:
   ![Import ova wizard](/images/oidc-provider.png) 

1. Create an IAM role of the type of Web identity and assign it to this OIDC provider. 
    1. In order to grant certain pod an access to the desired AWS resources:
        * On the cluster side, youcreate a service account in a the namespace of this pod on the EKS-A cluster. Then youassociate this service account to our pod.
        * On AWS side, youcreate an IAM role with a trust relationship for the OIDC provider (ISSUER_HOSTPATH).
        * And youadd in the trust policy the desired service accounts that youwant to enable them accessing the privileged AWS resources. 

        Refer this [document](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition_operators.html) for different ways of configuring one or multiple service accounts through the condition operators in the trust relationship.

    1. In our scenario here youare creating an IAM role with a trust policy that lists three service accounts that are located in three namespaces. Each service account want to have access to same list of privileges, but you can create a separate IAM role with different privileges for each service account.

        ```bash
        cat > trust-policy.json << EOF
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                        "Federated": "arn:aws:iam::$ACCOUNT_ID:oidc-provider/$ISSUER_HOSTPATH"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity",
                    "Condition": {
                        "StringEquals": {
                            "$ISSUER_HOSTPATH:aud": ["sts.amazonaws.com"],
                            "$ISSUER_HOSTPATH:sub": [
        "system:serviceaccount:default:test",
        "system:serviceaccount:payment:app1",
        "system:serviceaccount:sales:app2"
        ]
                        }
                    }
                }
            ]
        }
        EOF
        ```
    1. Next, you attach existing AWS managed policy to this role, or you create custom policies with the permissions that you want your application running in the pod to use. In our scenario youare associating S3, DynamoDB, abd ECR managed policies to this role.

        ```bash
        aws iam create-role --role-name Sample-app-role --assume-role-policy-document file://trust-policy.json
        aws iam attach-role-policy --role-name Sample-app-role --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        aws iam attach-role-policy --role-name Sample-app-role --policy-arn arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
        aws iam attach-role-policy --role-name Sample-app-role --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
        ```
    1. After the role is created, note down the name of this IAM Role as OIDC_IAM_ROLE. After the cluster is created, you can create more service accounts on your EKS-A cluster and grant them this role if you want by editing the trust relationship of this role youcreated in step1. 

    NOTE: You would need to repeat the same OIDC provider setup for each cluster you want to enable IRSA on. Make sure to have a sparate bucket for each cluster. 

